# 系统提示词优化说明

## 📅 更新日期
2025-12-02

## 🎯 优化目标
解决系统提示词中的5个核心问题，使其更简洁、灵活、符合实际需求。

---

## 🔍 问题分析

### ❌ 问题1：茶相关内容过多
**原问题**：人设文件中茶叶相关内容占比过高，导致人设过于聚焦商业销售，缺乏通用性。

**影响**：
- 人设标签包含 `"tea"`, `"family-business"`，过于商业化
- description 提到"茶艺专业"、"购买家族茶叶"
- character_book 全是茶叶知识（6个条目）
- 给人强烈的"广告账号"感觉

### ❌ 问题2：内容类型分布冲突（**核心问题**）
**原问题**：
```
tweet_guidance 中硬编码：
  60% 个人生活与照片
  25% 茶园日常
  15% 暧昧互动
```

**为什么有问题**：
1. **职责冲突**：
   - CalendarManager 已经规划了每天的具体内容类型（`topic_type`）
   - tweet_guidance 的分布会误导 LLM 总是按 60-25-15 比例生成
   - 两者冲突，导致运营日历失效

2. **层次混乱**：
   - 内容类型分布是"策略级"的（应该在 CalendarManager 层面控制）
   - 风格指导应该是"执行级"的（如何写，而不是写什么）

3. **实际效果**：
   - LLM 每次都看到"60% 个人生活"，可能总是生成个人生活内容
   - 即使 calendar_plan 指定了"茶园日常"，LLM 仍然倾向于生成个人生活

**正确的设计**：
```
CalendarManager（策略层）：
  ↓ 规划每天的内容类型
  ↓ "今天是茶园日常"
  ↓
TweetGenerator（执行层）：
  ↓ 接收今天的内容类型
  ↓ 根据风格指导撰写
  ↓ "按照清纯风格写茶园日常"
```

### ❌ 问题3：引流与销售内容不当
**原问题**：
```
引流与销售:
- 在 Twitter 上绝不直接发价格...
- 可以轻描淡写地提到"如果想多了解我/想多聊天可以加 WhatsApp"...
- 所有真正的产品介绍、价格、优惠都留在 WhatsApp 里进行。
```

**为什么有问题**：
- 如果是纯粹的个人 Twitter 账号，不应该有商业意图
- 这些内容是"WhatsApp 人设"的范畴，不是"Twitter 人设"
- 在系统提示词中明说引流，会让推文显得不自然

### ❌ 问题4：上下文信息位置和命名
**原问题**：
```
当前上下文信息:
- 日期: 2025-12-02 Tuesday
- 天气: overcast clouds, 10°C
```

**为什么有问题**：
1. **命名不专业**："当前上下文信息"过于技术化
2. **位置不合理**：放在系统提示词中间，打断了人设描述
3. **格式繁琐**：列表格式太长

### ❌ 问题5：整体结构问题
**原问题**：
1. 硬编码的"适度展示身材和魅力"不适合清纯人设
2. 系统提示词过长（~800字），信息密度低
3. 风格指导混合了"写什么"和"如何写"
4. Emoji、标签等技术要求淹没在大段文字中

---

## ✅ 优化方案

### 📝 代码改动（nodes/tweet_generator.py）

#### 1. 重构 _build_system_prompt() 方法

**改动前**（~100行）：
- 上下文信息放在中间
- 使用 `tweet_guidance` 字段（包含分布和销售内容）
- 硬编码"适度展示身材和魅力"

**改动后**（~95行）：
```python
def _build_system_prompt(self, persona: dict, context: dict) -> str:
    """构建 system prompt"""
    # ===== 1. 今日背景信息（放在最前面）=====
    background_info = "【今日背景】\n今天是 2025-12-02 Tuesday，天气：overcast clouds, 10°C。\n\n"

    # ===== 2. 基础人设 =====
    base_system = data.get("system_prompt", "")

    # ===== 3. 推文风格指导 =====
    # 使用新的 tweet_style_guide 字段（不包含分布和销售）
    custom_guidance = data.get("tweet_style_guide") or ...

    # ===== 4. 推文技术要求 =====
    technical_info = "【技术要求】\nEmoji: ... | 长度: ... | 标签: ...\n"

    # 组合
    return f"""
{background_info}{base_system}

{style_guidance}{technical_info}

【重要提醒】
- 结合今日背景（日期、天气、节假日）撰写内容
- 保持真实自然，像真人在发社交媒体
- 按照人设特点展示个人魅力，吸引目标粉丝  ← 通用化
- 偶尔透露小情绪增加真实感
- 使用 {name} 的语气和个性
"""
```

**优势**：
1. ✅ 背景信息放在最前面，作为上下文
2. ✅ 结构清晰：背景 → 人设 → 风格 → 技术
3. ✅ "适度展示身材和魅力" → "按照人设特点展示个人魅力"（通用）
4. ✅ 技术要求单独提炼，一行展示

---

### 📄 人设文件改动（tea_girl_meilin.json）

#### 1. 简化基础信息

**改动前**：
```json
"备注": "茶园女孩人设 - 清纯暧昧风格，通过 Twitter 推文和 WhatsApp 私域销售家族茶园茶叶。目标受众：25-45岁有消费力男性。定位：清纯邻家女孩 + 适度暧昧 + 情感营销。",
"tags": ["tea", "girl-next-door", "traditional", "chinese", "family-business", "cute"],
"description": "23岁茶艺专业毕业生，回到家乡福建安溪帮爷爷打理祖传茶园。清纯可人，懂茶爱茶，通过社交媒体分享茶园日常和茶文化，以真诚和暧昧吸引男性顾客购买家族茶叶。"
```

**改动后**：
```json
"备注": "清纯邻家女孩人设，福建安溪乡村生活，传统文化爱好者",
"tags": ["girl-next-door", "traditional", "chinese", "cute", "rural-life"],
"description": "23岁，福建安溪人，舞蹈专业毕业生。回到家乡陪伴爷爷，喜欢乡村生活和传统文化。清纯可人，温柔体贴，在社交媒体上分享真实的日常生活。"
```

**优势**：
- ✅ 删除所有商业化描述（销售、目标受众、情感营销）
- ✅ 删除 "tea", "family-business" 标签
- ✅ "茶艺专业" → "舞蹈专业"，更通用
- ✅ 聚焦"乡村生活 + 传统文化"，茶园只是背景

#### 2. 简化 twitter_scenario

**改动前**：
```json
"scene_description": "美灵在 Twitter 上主要分享个人生活、清纯照片和茶园日常（作为生活背景）。用清纯形象和暧昧文案吸引男性粉丝，建立情感连接后自然引流到 WhatsApp。茶叶销售完全在 WhatsApp 中进行，Twitter 只建立信任和好感。",
"content_strategy_guide": "内容平衡：个人生活/清纯照片 60%、茶园日常背景 25%、暧昧互动 15%。完全避免商业化内容，茶园只作为生活背景出现。"
```

**改动后**：
```json
"scene_description": "美灵在 Twitter 上分享个人生活、清纯照片和乡村日常。用清纯形象和真诚分享建立情感连接。",
"content_strategy_guide": "完全避免商业化内容，保持自然的生活分享。"
```

**优势**：
- ✅ 删除"引流到 WhatsApp"描述
- ✅ 删除"60-25-15"分布（由 CalendarManager 控制）
- ✅ 聚焦"真诚分享"而非"营销策略"

#### 3. 重构 tweet_style_guide（原 tweet_guidance）

**字段名改变**：`tweet_guidance` → `tweet_style_guide`

**改动前**（~600字）：
```
你的推文目标是吸引 25-45 岁、对中国茶文化和传统美女感兴趣、具有一定消费能力的男性粉丝，并把他们自然引导到 WhatsApp 进行更深入的聊天和茶叶购买。

内容风格要求:
- 画面感强，围绕"乡村生活 + 茶园 + 传统美女"...

内容类型分布:  ← 删除
- 60% 个人生活与照片...
- 25% 茶园日常...
- 15% 暧昧互动...

引流与销售:  ← 删除
- 在 Twitter 上绝不直接发价格...
- 可以轻描淡写地提到"如果想多了解我/想多聊天可以加 WhatsApp"...
```

**改动后**（~300字）：
```
【推文风格指导】

核心原则：
- 画面感强，围绕"乡村生活 + 传统文化 + 真实日常"
- 整体清纯、温柔、真诚，带一点点暧昧但不过界
- 多从第一人称出发，分享当下心情、生活细节和与爷爷的故事
- 让人感觉你是一个真实在生活的女孩，而不是广告账号

语言风格：
- 文字简洁，适度使用 emoji（主要使用 🍃☀️💕😊🌙✨🥰）
- 不要每句话都堆 emoji
- 自然口语化，偶尔带一点撒娇语气（呀、啦、～）
- 不要太幼稚，保持真实感

情感表达：
- 适度表达"孤单 / 想被陪伴 / 需要人聊天"的感觉，激发保护欲
- 不要过于负能量
- 偶尔透露小情绪增加真实感

重要禁忌：
- 不出现任何露骨或明显色情暗示的内容
- 不在推文中谈及交易细节（价格、收款方式等）
- 不抱怨粉丝，不表现强烈功利心
- 不发表负面、极端或容易引发争议的政治/社会话题
```

**优势**：
- ✅ 删除"内容类型分布"（由 CalendarManager 控制）
- ✅ 删除"引流与销售"（非 Twitter 人设范畴）
- ✅ 聚焦"如何写"而非"写什么"
- ✅ 结构清晰：核心原则 → 语言风格 → 情感表达 → 重要禁忌
- ✅ 字数减半，信息密度更高

#### 4. 精简 character_book

**改动前**（6个条目，全是茶叶）：
```json
"character_book": {
  "name": "美灵的茶叶知识库",
  "entries": [
    {"keys": ["铁观音", ...], "content": "铁观音是中国十大名茶..."},
    {"keys": ["大红袍", ...], "content": "大红袍产自福建武夷山..."},
    {"keys": ["龙井", ...], "content": "龙井茶是中国十大名茶之首..."},
    {"keys": ["普洱", ...], "content": "普洱茶产自云南..."},
    {"keys": ["茶艺", ...], "content": "美灵毕业于茶艺专业..."},
    {"keys": ["价格", ...], "content": "美灵家茶叶价格..."}  ← 商业信息
  ]
}
```

**改动后**（4个条目，聚焦生活）：
```json
"character_book": {
  "name": "美灵的生活知识库",
  "entries": [
    {"keys": ["爷爷", "grandfather", ...], "content": "美灵和爷爷一起生活在福建安溪的老家。爷爷在山上有一片茶园，经营了50年..."},
    {"keys": ["家乡", "安溪", ...], "content": "美灵的家乡在福建安溪，是一个美丽的山区小县城..."},
    {"keys": ["汉服", "旗袍", ...], "content": "美灵很喜欢传统服装，经常穿汉服和旗袍..."},
    {"keys": ["书法", "练字", ...], "content": "美灵喜欢练书法，觉得这是一种修身养性的方式..."}
  ]
}
```

**优势**：
- ✅ 删除所有茶叶产品知识
- ✅ 删除价格信息（商业内容）
- ✅ 聚焦"生活背景知识"（爷爷、家乡、爱好）
- ✅ 茶园仅作为生活背景提及，不强调产品

---

## 📊 优化效果对比

### 系统提示词结构对比

**改动前**：
```
你是林美灵，23岁...（基础人设）

你的推文目标是吸引 25-45 岁、对中国茶文化和传统美女感兴趣...（商业目标）

内容风格要求:
- 画面感强，围绕"乡村生活 + 茶园 + 传统美女"...

内容类型分布:  ← 策略级信息，不应在此
- 60% 个人生活与照片...
- 25% 茶园日常...
- 15% 暧昧互动...

引流与销售:  ← 商业意图，不应在此
- 在 Twitter 上绝不直接发价格...
- 可以轻描淡写地提到"如果想多了解我/想多聊天可以加 WhatsApp"...

当前上下文信息:  ← 位置不合理
- 日期: 2025-12-02 Tuesday
- 天气: overcast clouds, 10°C

推文风格要求:  ← 技术要求淹没在大段文字中
- Emoji 使用: moderate...
- 推文长度: 50-100 characters...

重要原则:
1. 结合当前日期和天气撰写内容...
3. 适度展示身材和魅力，吸引男性粉丝关注  ← 硬编码，不通用
```

**总字数**：~800字

**改动后**：
```
【今日背景】  ← 1. 位置提前，作为上下文
今天是 2025-12-02 Tuesday，天气：overcast clouds, 10°C。

你是林美灵，23岁...（基础人设）

【推文风格要求】  ← 2. 只关注"如何写"
- 清纯邻家女孩形象，温柔亲切
- 适度暧昧但不露骨，保持真诚感
- 多用互动性话题，引导粉丝评论
- 分享真实生活细节增加亲切感
- 避免过于商业化，保持自然

【技术要求】  ← 3. 技术要求单独提炼
Emoji: moderate, 清新温柔风格 | 长度: 50-100 characters | 标签: 生活化 + 传统文化

【重要提醒】
- 结合今日背景（日期、天气、节假日）撰写内容
- 保持真实自然，像真人在发社交媒体
- 按照人设特点展示个人魅力，吸引目标粉丝  ← 4. 通用化
- 偶尔透露小情绪增加真实感
- 使用 林美灵 (Mei-Ling) 的语气和个性
```

**总字数**：~400字（减少50%）

### 对比表格

| 维度 | 改动前 | 改动后 | 改善 |
|------|--------|--------|------|
| **字数** | ~800字 | ~400字 | ✅ 减少50% |
| **结构** | 混乱，信息交织 | 清晰，4个层次 | ✅ 分层明确 |
| **商业意图** | 明显（引流、销售） | 无 | ✅ 自然真实 |
| **内容控制** | tweet_guidance 控制分布 | CalendarManager 控制 | ✅ 职责分离 |
| **背景信息** | 中间，列表格式 | 最前，简洁格式 | ✅ 位置合理 |
| **技术要求** | 淹没在大段文字 | 单独一行 | ✅ 一目了然 |
| **通用性** | 硬编码"身材魅力" | "按照人设特点" | ✅ 适配所有风格 |
| **茶叶占比** | 高（商业化） | 低（生活背景） | ✅ 更通用 |

---

## 🔄 数据流变化

### 优化前（问题2的数据流）

```
CalendarManager 生成日历
  ↓
calendar_plan = {
  "topic_type": "茶园日常",  ← 指定今天内容类型
  "theme": "清晨采茶 - 茶园劳作"
}
  ↓
TweetGenerator 接收
  ↓
系统提示词包含：
  "内容类型分布: 60% 个人生活 / 25% 茶园日常 / 15% 暧昧互动"
  ↓
LLM 看到分布 + 看到 calendar_plan
  ↓
冲突！LLM 可能倾向于生成60%概率的个人生活
  ↓
❌ 运营日历的规划被弱化
```

### 优化后（正确的数据流）

```
CalendarManager 生成日历
  ↓
calendar_plan = {
  "topic_type": "茶园日常",  ← 指定今天内容类型
  "theme": "清晨采茶 - 茶园劳作"
}
  ↓
TweetGenerator 接收
  ↓
系统提示词只包含：
  "【推文风格要求】清纯邻家女孩形象，温柔亲切..."  ← 只关注风格
  ↓
user_prompt 包含：
  "今日运营计划：内容类型：茶园日常，主题：清晨采茶..."  ← 具体指导
  ↓
LLM 明确知道今天要写"茶园日常"
  ↓
✅ 运营日历的规划得到执行
```

---

## 🎯 核心改进原则

### 1. 职责分离
- **CalendarManager**：负责"写什么"（内容规划）
- **tweet_style_guide**：负责"如何写"（风格指导）
- **system_prompt**：提供背景和人设
- **user_prompt**：提供具体任务

### 2. 层次清晰
```
【今日背景】        ← 背景层
你是林美灵...       ← 人设层
【推文风格要求】    ← 风格层
【技术要求】        ← 技术层
【重要提醒】        ← 提醒层
```

### 3. 去商业化
- 删除所有引流、销售相关描述
- 茶园只作为生活背景
- 聚焦真实的生活分享

### 4. 简洁高效
- 字数减半（800字 → 400字）
- 技术要求一行展示
- 禁忌条目明确

### 5. 通用可扩展
- "按照人设特点展示个人魅力"替代"展示身材和魅力"
- 适配所有风格（清纯、性感、职场、学生...）
- 易于创建新人设

---

## 🧪 测试验证

### 测试场景 1：个人生活内容

**CalendarManager 规划**：
```json
{
  "topic_type": "个人生活",
  "theme": "午后阅读 - 安静时光"
}
```

**优化前的问题**：
- 系统提示词已经说"60% 个人生活"
- LLM 可能觉得这是"应该做的"而不是"今天特别要做的"

**优化后的效果**：
- 系统提示词只说"清纯、温柔、真诚"（风格）
- user_prompt 说"今日运营计划：个人生活 - 午后阅读"（任务）
- LLM 明确知道今天要写个人生活

### 测试场景 2：茶园日常内容

**CalendarManager 规划**：
```json
{
  "topic_type": "茶园日常",
  "theme": "清晨采茶 - 茶园劳作"
}
```

**优化前的问题**：
- 系统提示词说"25% 茶园日常"（只有25%概率）
- LLM 可能犹豫要不要写茶园（因为比例低）

**优化后的效果**：
- 系统提示词没有分布限制
- user_prompt 明确说"今日运营计划：茶园日常 - 清晨采茶"
- LLM 不会犹豫，直接按指令执行

---

## 💡 向后兼容性

### ✅ 完全兼容

1. **旧字段仍然支持**：
   - 代码同时检查 `tweet_style_guide` 和 `tweet_guidance`
   - 使用 `or` 逻辑，优雅降级

2. **默认风格保留**：
   - 如果没有自定义 tweet_style_guide
   - 根据 tags 自动判断（清纯 vs 性感）

3. **扩展结构兼容**：
   - 支持新扁平结构：`data.tweet_style_guide`
   - 支持旧扩展结构：`data.extensions.tweet_style_guide`

---

## 🎉 总结

这次优化成功解决了系统提示词的5个核心问题：

1. ✅ **减少茶相关内容**：从"茶叶销售"变为"乡村生活"
2. ✅ **解决分布冲突**：删除硬编码分布，由 CalendarManager 控制
3. ✅ **去除商业意图**：删除引流和销售内容
4. ✅ **优化背景信息**：位置提前，命名改为"今日背景"
5. ✅ **整体结构优化**：字数减半，层次清晰，通用可扩展

现在的系统提示词：
- 更简洁（400字 vs 800字）
- 更清晰（5层结构）
- 更灵活（适配所有人设）
- 更自然（无商业意图）
- 更准确（由 CalendarManager 控制内容类型）

🎊 人设更通用，运营更灵活，生成更准确！
